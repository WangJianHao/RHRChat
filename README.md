# RHRChat项目

基于netty框架的即时聊天系统，使用java语言开发项目，使用mysql关系型数据库存储用户信息、聊天组信息等，使用maven管理项目。

开发环境：

系统：windows 10

IDE：IDEA

JDK：1.8.0_231 64位

数据库：mysql 8.0.18

消息传输协议：json

## 用户端

用户端全程采用Swing类库来渲染界面，并使用相关jar包美化。实现可视化的登录、注册、好友列表、聊天等界面。

### 一、用户账号模块

主要是对用户表的增删改查的具体功能描述，主要是四个功能：登录、注册、忘记密码、修改密码。

#### 1.用户登录功能

用户输入账号和密码，通过底层的处理封装为JSON消息发送给服务端请求登录。账号由系统自动生成。

#### 2.新用户注册功能

用户输入邮箱，密码和用户名，一个邮箱一个账号，系统会将账号发送到对应的邮箱中。用户根据账号和密码进行登录。

#### 3.忘记密码功能

用户输入账号，系统将密码发送到对应注册的邮箱中。

#### 4.修改密码功能

用户登录成功时可使用本功能。需要输入账号，旧密码和新密码。

### 二、聊天模块

#### 1.一对一聊天功能

底层会将消息封装为JSON发送给服务端，但是消息中尽量不要出现}，这涉及到本系统对于TCP粘包的处理。服务端接收到消息后需要查看接收端是否在线，如果在线将消息转发给接收端，如果不在线就记录在消息表中，等到接收端上线时会将离线消息发送给接收端。

#### 2.群聊功能

  所有的好友发送(考虑好友是否在线问题)

#### 3.好友列表

  用户上线时，将所有好友发送给用户。本系统维护了一个好友表。

#### 4.好友上下线通知

用户表里并没有用户是否在线的字段，是通过缓存来判断用户是否在线。当然在用户表对应的实体类中可加上是否在线的相关字段，方便客户端的发送消息。

### 三、文件传输模块

#### 1.指定用户发送文件

因为直接使用channel传输文件的话就很容易造成阻塞，因此本系统采用的思想是，发送方先给服务端发送一个JSON代表要发送文件，服务端判断接收端是否在线，如果在线就开辟两个端口，并启动子线程采用BIO启动两个ServerSocket实例监听这两个端口，然后主线程将端口信息发送给发送方和接收方，两者接收到端口信息后也会启动子线程采用BIO连接服务端的这两个端口，服务端在接收到发送方传输过来的文件流之后会转发给接收方。如果接收方不在线，服务端就只会开启一个端口，然后启动子线程接收发送方的文件并将记录插入到文件记录表中，之后等接收方上线时，服务端会将文件转发给接收方。

#### 2.群发文件

发送方到服务端只需要传输一次，之后将文件保存在服务端，然后将文件分别转发给聊天组中的其他成员。

## 服务端

### 一、网络连接层

接收到客户端传过来的JSON信息后，经过处理得到JSON的数据类型，然后根据数据类型的不同使用对应的业务逻辑层的类执行对应的方法。

### 二、业务处理层

包括对登录信息的处理以及调用工具类执行一些特殊的方法，包括发送邮件，放入缓存，获取数据库连接等方法。

### 三、数据落地层

通过c3p0连接池获取连接，根据从业务逻辑层传下来的参数执行相应的方法，对数据库进行增删改查，最后释放资源。

## 数据库

### 一、用户表

### 二、聊天组表

### 三、消息表

### 四、文件记录表
